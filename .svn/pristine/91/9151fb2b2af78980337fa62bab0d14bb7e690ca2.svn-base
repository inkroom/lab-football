var match;
var token;
context = {
    num: 10,
    btn_num: 0,
    btn_max: 5,
    totalSize: 0,
    cur_page: 0,
    cur_index: 1,
    page_num: 0,
    isError: false,
    isCreateBtn: false,
    //isCreatePage: true
};
trData = "<tr idSchedule='{idSchedule}'><td>{time}</td><td>{place}</td><td><a href='javascript:showdiv();' id='strHref' class='hpn-1'>{teamA}</a></td><td><b>{scoreA}&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;{scoreB}</b></td><td><a href='#'>{teamB}</a></td><td>{status}</td><td><a onclick='modify(this)'><button class='btn btn-success btn-sm gwz'>修改</button></a><a onclick=\"referee(this)\"><button class=\"btn btn-warning btn-sm gwz\">裁判</button></a><a onclick='delet(this)'><button class='btn btn-danger btn-sm gwz'>删除</button></a></td></tr>";
liData = "<li dom_type='page_btn' onclick='pageClick(this)' index='{index}'><a href='#'>{pageNum}</a></li>";

$(document).ready(function () {
    match = document.getElementById("mid").value;
    token = $("#token").val().trim();
    matchDetails();
    $("#upBtn").attr("href", "/match/turnUpdate?id=" + match + "&token=" + token);
    $("#AddBtn").attr("href", "/match/turnAddSch?id=" + match + "&token=" + token);

    $("#schedule-list").click(function () {
        schedule();
    });
    $("#profile-tab").click(function () {
        examine();
    });

});


function getMatchLevel(level) {
    switch (level) {
        case 0:
            return "校级";
        case 1:
            return "县级";
        case 2:
            return "市级";
        case 3:
            return "省级";
        case 4:
            return "国级";
        default:
            return "Error Level Code" + level;
    }
}


function getMatchStatus(status) {
    switch (status) {
        case 0:
            return "报名阶段";
        case 1:
            return "进行中";
        case 2:
            return "已结束";
        case 3:
            return "删除状态"
    }
}

var matchDetails;

function matchDetails() {
    ajax({
        url: getRootPath() + "/match/MatchInfo/" + match,
        success: function (result) {
            matchDetails = result;
                $("#matchName").text(matchDetails.data.matchInfo.name);
                $("#titleName").append(matchDetails.data.matchInfo.name);
                $("#matchLevel").text(getMatchLevel(matchDetails.data.matchInfo.level));
                $("#matchStatus").text(getMatchStatus(matchDetails.data.matchInfo.status));
                $("#matchNumPlayer").text(matchDetails.data.matchInfo.numPlayer + "人");
                $("#matchStartTime").text(parseTime(matchDetails.data.matchInfo.startDate));
                $("#matchDeadLine").text(parseTime(matchDetails.data.matchInfo.applyDeadline));
            schedule();
            }
        }
    );
}


function pageClick(cur_this) {
    $(cur_this).attr("class", "active");
    var selector = "[index=" + (context.cur_index) + "]";
    $(selector).removeAttr("class");
    showSchedule(match, String($(cur_this).text()));
    context.cur_index = parseInt($(cur_this).attr("index"));
}


function showSchedule(idMatch, page) {
    postData = "idMatch=" + idMatch;
    ajax({
        async: false,
        url: getRootPath() + "/schedule/showSchedule/" + page,
        type: "POST",
        data: postData,
        dataType: "json",
        error: function () {
            context.isError = true;
            $("#schedule-data tbody").empty();
            errorMessge = '<tr><td></td><td></td><td>获取信息失败!</td><td></td><td></td><td></td></tr>';
            $("#schedule-data tbody").append(errorMessge);
            $("#schedule-data").css("visibility", "visible");
        },
        success: function (data, status) {
            token = data.token;
            if (data.status == 1) {
                var tr = $("<tr></tr>").append("暂无赛程");
                tr.appendTo("#body");
                return false;
            }
            context.isError = false;
            context.totalSize = data.data.size;
            context.cur_page = page;
            var realSize = data.data.schedule.length;
            var num = realSize <= context.num ? realSize : context.num;
            context.isCreateBtn = (data.data.size > context.num);
            $("#schedule-data tbody").empty();
            for (var i = 0; i < num; i++) {
                var time = new Date(Number(data.data.schedule[i].time));
                var beginTime = String(time.getFullYear() + "/" + time.getMonth() + "/" + time.getDate());
                var state = null;
                switch (data.data.schedule[i].status)
                {
                    case 0:
                        state = "正在准备";
                        break;
                    case 1:
                        state = "正在比赛";
                        break;
                    case 2:
                        state = "比赛结束";
                        break;
                    case 3:
                        state = "已删除";
                        break;
                }
                var tr = trData.replace("{time}", beginTime).replace("{place}", data.data.schedule[i].place)
                    .replace("{teamA}", data.data.schedule[i].teamNameA).replace("{scoreA}", String(data.data.schedule[i].goalA))
                    .replace("{scoreB}", String(data.data.schedule[i].goalB)).replace("{teamB}", data.data.schedule[i].teamNameB)
                    .replace("{status}", state)
                    .replace("{idSchedule}", data.data.schedule[i].idSchedule);

                $("#schedule-data tbody").append(tr);
                $(tr).attr("idSchedule", data.data.schedule[i].idSchedule);
            }
            $("#schedule-data").css("visibility", "visible");
        }
    });
}

function modify(cur_this) {
    var idSchedule = $(cur_this).parentsUntil("#body").filter("tr").attr("idSchedule");
    var data = "idSchedule=" + idSchedule + "&match=" + match + "&token=" + $("#token").val().trim();
    window.location.href = "/schedule/modifyPage?" + data;
}

function referee(cur_this) {
    var idSchedule = $(cur_this).parentsUntil("#body").filter("tr").attr("idSchedule");
    window.location.href = "/schedule/turnReferee?idSchedule=" + idSchedule + "&token=" + token;
}

function delet(cur_this) {
    var idSchedule = $(cur_this).parentsUntil("#body").filter("tr").attr("idSchedule");
    layer.confirm('确认删除吗？', {
        btn: ['确认', '取消'], //按钮
        title: "删除赛程"
    }, function () {
        ajax({
            url: getRootPath() + "/schedule/delete",
            type: "POST",
            data: {"idSchedule": idSchedule, "token": $("#token").val().trim()},
            success: function (result) {
                if (result.status == 0) {
                    layer.msg('删除成功', {icon: 1});
                    schedule();
                }
            },
            error: function () {
                layer.msg('删除失败', {icon: 2});
            }
        });
    });
}

function schedule() {


    // $("#schedule-list").click(function ()
    // {
        //if (context.isCreatePage)
        {
            showSchedule(match, 1);
            if (context.isError) {
                return;
            }



            if (context.isCreateBtn) {
                context.page_num = parseInt(context.totalSize / context.num);
                if (context.page_num < context.totalSize / context.num) {
                    context.page_num++;
                }
                var realBtn_num = (context.page_num < context.btn_max) ? context.page_num : context.btn_max;
                for (var i = 1, tmp = ""; i <= realBtn_num; i++) {
                    tmp += liData.replace("{pageNum}", String(i)).replace("{index}", String(i));
                }
                context.btn_num = realBtn_num;
                $("#previous").after(tmp);
                $("#pageBtn").css("display", "block");
                $("[dom_type=page_btn]:eq(0)").attr("class", "active");
            }
            //context.isCreatePage = false;
        }
    // }
    // );

    $("#next").click(function ()
    {
        $(this).children("a").css("background-color", "white");
        if (context.cur_page >= context.page_num)
        {
            return;
        }
        else if (context.cur_index === context.btn_num)
        {
            $("[dom_type=page_btn]").each(function () {
                var number = parseInt($(this).text()) + context.btn_num;
                if (number > context.page_num) {
                    $(this).css("display", "none");
                }
                else {
                    $(this).children("a").text(String(number));
                }
            });
            $("[index=1]").click();
        }
        else {
            var selector = "[index=" + (context.cur_index + 1) + "]";
            $(selector).click();
        }

    });

    $("#previous").click(function ()
    {
        $(this).children("a").css("background-color", "white");
        if (context.cur_page <= 1)
        {
            return;
        }
        if (context.cur_index === 1)
        {
            var number = parseInt($("[index=1]").text()) - context.btn_num;
            $("[dom_type=page_btn]").each(function () {
                $(this).children("a").text(String(number));
                $(this).css("display", "inline");
                number++;
            });
            var selector = "[index=" + context.btn_max + "]";
            $(selector).click();
        }
        else {
            var selector = "[index=" + (context.cur_index - 1) + "]";
            $(selector).click();
        }
    });
};


function examine() {
    orgExamine();
}

function input(oid, status) {
    ajax({
        url: getRootPath() + "/match/setExamine",
        data: {id: oid, status: status, token: $('#token').val().trim()},
        type: "POST",
        success: function (result) {
            if (result.status == 0) {
                $("#examine").empty();
                $("#playerbody").empty();
                $("#button").empty();
                $("#pageInfo").empty();
                orgExamine();
            }
        }
    })
}

function orgExamine() {
    $("#examine").empty();
    ajax({
        url: getRootPath() + "/match/listExamine",
        data: {mid: match},
        type: "POST",
        success: function (result) {
            token = result.data.token;
            $.each(result.data.examine, function (index, item) {
                var oid = item.orgId;
                var div1 = $("<div></div>").attr("class", "mouse");
                var div2 = $("<div></div>").attr("class", "t-h-n");
                var a = $("<a></a>").attr("data-toggle", "collapse").append(item.orgName).attr("class", "ona").attr("oid", oid);
                div2.append(a);
                var div3 = $("<div></div>").attr("class", "collapse t-h-bo");
                var ul = $("<ul></ul>");
                $.each(item.teamName, function (item) {
                    var li = $("<li></li>").append(item);
                    ul.append(li);
                });
                div3.append(ul);
                div1.append(div2).append(div3).appendTo("#examine");
                if (index == 0) {
                    listPlayer(1, oid);
                }
            });
        }

    })
}

$(document).on("click", ".ona", function () {
    listPlayer(1, $(this).attr("oid"));
});
$(document).on("click", ".pass", function () {
    input($(this).attr("oid"), 1);
});
$(document).on("click", ".danger", function () {
    input($(this).attr("oid"), 2);
});

function listPlayer(pn, oid) {
    $("#playerbody").empty();
    $("#button").empty();
    ajax({
        url: getRootPath() + "/match/listExaminePlayer",
        data: {pn: pn, oid: oid},
        type: "POST",
        success: function (result) {
            token = result.data.token;
            $.each(result.data.playerPage.list, function (index, item) {
                var playerTd = $("<td></td>").append(item.playerName);
                var teamTd = $("<td></td>").append(item.teamName);
                $("<tr></tr>")
                    .append(playerTd)
                    .append(teamTd)
                    .appendTo("#playerbody")
            });
            var passA = $("<button></button>")
                .attr("type", "button")
                .attr("style", "margin-left: 20%;display: block;float: left;margin-top: -18px")
                .attr("class", "btn btn-success btn-sm pass")
                .attr("oid", oid)
                .append("通过");
            var dangerA = $("<button></button>")
                .attr("type", "button")
                .attr("style", "margin-left: 40%;display: block;float: left;margin-top: -18px")
                .attr("class", "btn btn-danger btn-sm danger")
                .attr("oid", oid)
                .append("拒绝");
            passA.appendTo("#button");
            dangerA.appendTo("#button");
            build_page_nav(result, oid)
        }

    })
}

// function toPage(pn) {
//     $.ajax({
//         url: "/match/listExamine",
//         data: {pn: pn, mid: match},
//         dataType: "json",
//         type: "POST",
//         success: function (result) {
//             if (result.status == 0) {
//                 buildTable(result);
//                 build_page_nav(result);
//             }
//             else if (result.status == 1) {
//                 $("#body").empty();
//                 $("<tr></tr>").append("无数据").appendTo("#body");
//
//             }
//         }
//     });
// }

// function buildTable(result) {
//     nowpage = result.data.pageInfo.pageNum;
//     $("#body").empty();
//     $.each(result.data.pageInfo.list, function (index, item) {
//         var orgid = item.orgId;
//         var nameTd = $("<td></td>").append(item.orgName);
//         var teamTd = $("<td></td>");
//         $.each(item.teamName, function (index, item) {
//             var li = $("<li></li>").append(item);
//             teamTd.append(li).append(" ");
//         });
//         var passBtn = $("<button></button>").addClass("btn btn-success pass").append("通过");
//         passBtn.attr("id", orgid);
//         var refuseBtn = $("<button></button>").addClass("btn btn-danger danger").append("拒绝");
//         refuseBtn.attr("id", orgid);
//         var btn = $("<td></td>").append(passBtn).append(" ").append(refuseBtn);
//         $("<tr></tr>")
//             .append(nameTd)
//             .append(teamTd)
//             .append(btn)
//             .appendTo("#body");
//
//     })
// }

// function build_page_info(result){
//     $("#page_info").empty();
//     $("#page_info").append("当前"+result.data.pageInfo.pageNum+"页，" +
//         "总"+result.data.pageInfo.pages+"页，总"+
//         result.data.pageInfo.total+"条记录")
//     thispage=result.datapageInfo.pageNum;
// }
function build_page_nav(result, oid) {
    $("#pageInfo").empty();
    var ul = $("<ul></ul>").addClass("pagination");
    var firstPageLi = $("<li></li>").append($("<a></a>").append("首页"));
    var prePageLi = $("<li></li>").append($("<a></a>").append("&laquo;"));
    if (result.data.playerPage.hasPreviousPage == false) {
        firstPageLi.addClass("disabled");
        prePageLi.addClass("disabled");
    } else {
        firstPageLi.click(function () {
            listPlayer(1, oid);
        });
        prePageLi.click(function () {
            listPlayer(result.data.playerPage.pageNum - 1, oid);
        });
    }

    var nextPageLi = $("<li></li>").append($("<a></a>").append("&raquo;"));
    var lastPageLi = $("<li></li>").append($("<a></a>").append("末页"));
    if (result.data.playerPage.hasNextPage == false) {
        nextPageLi.addClass("disabled");
        lastPageLi.addClass("disabled")
    }
    else {
        nextPageLi.click(function () {
            listPlayer(result.data.playerPage.pageNum + 1, oid);
        });
        lastPageLi.click(function () {
            listPlayer(result.data.playerPage.pages, oid);
        });
    }

    ul.append(firstPageLi).append(prePageLi);
    $.each(result.data.playerPage.navigatepageNums, function (index, item) {
        var numLi = $("<li></li>").append($("<a></a>").append(item));
        if (result.data.playerPage.pageNum == item) {
            numLi.addClass("active")
        }
        numLi.click(function () {
            listPlayer(item, oid)
        });
        ul.append(numLi);
    });
    ul.append(nextPageLi).append(lastPageLi);
    var navEle = $("<nav></nav>").append(ul);
    navEle.appendTo("#pageInfo");
}