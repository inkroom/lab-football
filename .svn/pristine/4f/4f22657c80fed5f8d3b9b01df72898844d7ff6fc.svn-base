/**
 * Created by 灵魂都在冒香气的神 on 2018/3/28.
 */

match = null;
idSchedule = null;
selectData = '<option teamId="{id}">{name}</option>';
context = {
    error: false
};
function initTeam(match)
{
    $.ajax({
        url: "/getTeam?matchId=" + match,
        type: "GET",
        dataType: "json",
        error: function ()
        {
            $("#teamA select").append('<option>未获取到队伍信息</option>');
            $("#teamB select").append('<option>未获取到队伍信息</option>');
            context.error = true;
        },
        success: function (teamData, status)
        {
            if (teamData.status == 5)
            {
                $("#teamA select").append('<option>未获取到队伍信息</option>');
                $("#teamB select").append('<option>未获取到队伍信息</option>');
                context.error = true;
                return;
            }
            var len = teamData.data.team.length;
            var allTeam = teamData.data.team;
            for (var i = 0; i < len; i++)
            {
                $("#teamA select").append(selectData.replace("{name}", allTeam[i].name).replace("{id}", allTeam[i].idTeam));
                $("#teamB select").append(selectData.replace("{name}", allTeam[i].name).replace("{id}", allTeam[i].idTeam));
            }
        }
    });
}

$(document).ready(function ()
{
    match = $("#secret").attr("match");
    idSchedule = $("#secret").attr("idSchedule");
    initTeam(match);
    if (context.error)
    {
        $("#submit").click(function ()
        {
            alert("获取队伍信息失败");          //记得还原
        });
        return;
    }
    $("#submit").click(function ()
    {
        var teamA = $("#teamA select").find("option:selected").attr("teamId");
        var teamB = $("#teamB select").find("option:selected").attr("teamId");
        var teamNameA = $("#teamA select").val();
        var teamNameA = $("#teamB select").val();
        if (teamA === teamB)
        {
            alert("不能选择相同的队伍");
            return;
        }
        var goalA = $("#goalA").val();
        var goalB = $("#goalB").val();
        if (goalA < 0 || goalB < 0 || goalA == "" || goalB == "")
        {
            alert("请填写正确的比分");
            return;
        }
        var tmp = $("#time").val();
        if (time == "")
        {
            alert("请选择开赛时间");
            return;
        }
        var time = Date.parse(tmp);
        var place = $("#place").val();
        if (place == "")
        {
            alert("请选择比赛地点");
            return;
        }
        var status = $("#status").find("option:selected").attr("status");
        var json = {
            // "teamNameA":teamNameA,
            // "teamNameB":teamNameB,
            "matchId": match,    //fuck
            "teamA": teamA,
            "teamB": teamB,
            "idSchedule": idSchedule,    //fuck
            "goalA": goalA,
            "goalB": goalB,
            "time": time,
            "place": place,
            "status": status
        };
        $.ajax({
            url: "/schedule/modify",
            type: "POST",
            dataType: "json",
            error: function ()
            {
                alert("修改失败");
            },
            success: function (backData, status)
            {
                if (backData.status == 0)
                {
                    alert("修改成功");
                    window.location.href = "/match/turnDetailsAdmin/?id=" + match    //刚才的页面
                }
                else
                {
                    alert("修改失败");
                }
            }
        })
    })
});
