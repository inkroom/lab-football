var num = 1;
$(document).ready(function () {
    
    $("#home-tab").click(function () {
        num = 1;
        toPage(1);
    });
    $("#profile-tab").click(function () {
        num = 2;
        toPage(1);
    });
    $("#dropdown1-tab").click(function () {
        num = 3;
        toPage(1);
    });
    toPage(1);
});

function toPage(pn) {
    $.ajax({
        url: "/match/listMatch",
        data: {num: num, pn: pn},
        type: "GET",
        success: function (result) {
            if (result.status == 0) {
                buildTable(result);
                build_page_nav(result);
            }
        }
    })
}

function buildTable(result) {
    var body;
    if (num == 1) {
        body = $("#tbody1");
    }
    else if (num == 2) {
        body = $("#tbody2");
    }
    else body = $("#tbody3");
    body.empty();
    $.each(result.data.pageInfo.list, function (index, item) {
        var itemid = item.idMatch;
        var a = $("<a></a>");
        a.attr('href', '/match/MatchInfo/' + itemid);
        a.append(item.name);
        var itemNameTh = $("<th ></th>").append(a);
        itemNameTh.attr("matchId", itemid);
        if (num == 1) var dateTd = $("<td></td>").append(parseTime(item.applyDeadline));
        else var dateTd = $("<td></td>").append(parseTime(item.startDate));
        var statusTd;
        switch (item.status) {
            case 2 :
                statusTd = $("<td></td>").append("已结束");
                break;
            case 1 :
                statusTd = $("<td></td>").append("正在进行");
                break;
            case 0 :
                statusTd = $("<td></td>").append("正在报名");
                break;
        }
        var otherTd;
        var b;
        if (num == 1) {
            if (item.status == 0) {
                b = $("<a></a>");
                b.attr('href', "/match/listSign/" + itemid);
                b.append("报名");
                otherTd = $("<td></td>").append(b);
            }
            else otherTd = $("<td></td>").append("不能进行报名");
        }
        else if (num == 2) {
            if (item.exstatus == 0) {
                otherTd = $("<td></td>").append("待审核");
            }
            else otherTd = $("<td></td>").append("已审核");
        }
        else if (num == 3) {
            b = $("<a></a>");
            b.attr('href', "/match/turnExamine/?id=" + itemid)
            b.append("审核列表");
            otherTd = $("<td></td>").append(b);
        }
        $("<tr></tr>")
            .append(itemNameTh)
            .append(dateTd)
            .append(statusTd)
            .append(otherTd)
            .appendTo(body);
    })
}

function build_page_nav(result) {
    $("div.pageInfo").empty();
    var ul = $("<ul></ul>").addClass("pagination");
    var firstPageLi = $("<li></li>").append($("<a></a>").append("首页"));
    var prePageLi = $("<li></li>").append($("<a></a>").append("&laquo;"));
    if (result.data.pageInfo.hasPreviousPage == false) {
        firstPageLi.addClass("disabled");
        prePageLi.addClass("disabled");
    } else {
        firstPageLi.click(function () {
            toPage(1);
        });
        prePageLi.click(function () {
            toPage(result.data.pageInfo.pageNum - 1);
        });
    }

    var nextPageLi = $("<li></li>").append($("<a></a>").append("&raquo;"));
    var lastPageLi = $("<li></li>").append($("<a></a>").append("末页"));
    if (result.data.pageInfo.hasNextPage == false) {
        nextPageLi.addClass("disabled");
        lastPageLi.addClass("disabled")
    }
    else {
        nextPageLi.click(function () {
            toPage(result.data.pageInfo.pageNum + 1);
        });
        lastPageLi.click(function () {
            toPage(result.data.pageInfo.pages);
        });
    }

    ul.append(firstPageLi).append(prePageLi);
    $.each(result.data.pageInfo.navigatepageNums, function (index, item) {
        var numLi = $("<li></li>").append($("<a></a>").append(item));
        if (result.data.pageInfo.pageNum == item) {
            numLi.addClass("active")
        }
        numLi.click(function () {
            toPage(item)
        });
        ul.append(numLi);
    });
    ul.append(nextPageLi).append(lastPageLi);
    var navEle = $("<nav></nav>").append(ul);
    navEle.appendTo("div.pageInfo");
}

function formatDate(date) {
    dates = date.split("/");
    if (dates.length == 3) {
        if (dates[1].length == 1) {
            dates[1] = "0" + dates[1];
        }
        if (dates[2].length == 1) {
            dates[2] = "0" + dates[2];
        }
        date = dates.join("-");
        return date;
    } else {
        return null;
    }
}

function parseTime(timestamp) {
    //转换时间戳
    var date = new Date(parseInt(timestamp)).toLocaleDateString();
    date = formatDate(date);
    return date;
}

