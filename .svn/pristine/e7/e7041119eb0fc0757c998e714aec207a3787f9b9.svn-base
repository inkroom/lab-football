<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>add-match</title>
    <%
        request.setAttribute("path", request.getContextPath());
    %>
    <link rel="stylesheet" type="text/css" href="../../../resources/lib/bootstrap/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="../../../resources/css/match/style.1.0.css"/>

    <script src="../../../resources/js/match/respond.js"></script>
    <script src="../../../resources/lib/jquery/jquery-1.11.3.js"></script>
    <script type="application/javascript" src="../../../resources/js/match/bootstrap2.min.js"></script>
    <script type="application/javascript" src="../../../resources/js/match/utils.js"></script>
    <script src="../../../resources/js/index.js"></script>

</head>
<body>
<input hidden id="token" value="${token}">
<jsp:include page="../common/head.jsp"/>
<input hidden id="mid" value="${mid}">
<div class="container mo-h">
    新增赛程
</div>
<div class="container">
    <form id="createSchForm" class="form-horizontal">
        <div class="form-group">
            <label for="orgA" class="col-sm-2 control-label">主队组织</label>
            <div class="col-sm-10">
                <select id="orgA" class="form-control input-sm">
                    <option>选择主队的队伍</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="teamA" class="col-sm-2 control-label">主队</label>
            <div class="col-sm-10">
                <select id="teamA" name="teamA" class="form-control input-sm">
                    <option>选择主队的队伍</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="orgB" class="col-sm-2 control-label">客队组织</label>
            <div class="col-sm-10">
                <select id="orgB" class="form-control input-sm">
                    <option>选择客队的组织</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="teamB" class="col-sm-2 control-label">客队</label>
            <div class="col-sm-10">
                <select id="teamB" name="teamB" class="form-control input-sm">
                    <option>选择客队的队伍</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="beginTime" class="col-sm-2 control-label">开赛时间</label>
            <div class="col-sm-10">
                <input id="beginTime" name="time" value="2018-03-28T17:27:33" type="datetime-local"
                       class="form-control" placeholder="请填写比赛时间">
            </div>
        </div>
        <div class="form-group">
            <label for="place" class="col-sm-2 control-label">开赛地点</label>
            <div class="col-sm-10">
                <input id="place" name="place" type="text" class="form-control" placeholder="请填写比赛地点">
            </div>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
                <input type="button" onclick="createSch();return false;" class="btn btn-success" value="确认"/>
                <a href="${path}/match/turnDetailsAdmin/?id=${mid}">
                    <button type="button" class="btn btn-danger">取消</button>
                </a>
            </div>
        </div>
    </form>
</div>
</body>
<script>
    var matchId;
    idSchedule = null;
    selectData = '<option value="{id}">{name}</option>';
    context = {
        error: false
    };

    function initOrg() {
        $.ajax({
            url: "/schedule/showOrgs/" + matchId,
            type: "GET",
            dataType: "json",
            success: function (orgData) {
                var len = orgData.data.orgs.length;
                var Orgs = orgData.data.orgs;
                if (len <= 0) {
                    $("#orgA").append('<option>未获取到组织信息</option>');
                    $("#orgB").append('<option>未获取到组织信息</option>');
                }
                $.each(Orgs, function (index, org) {
                    console.log(org);
                    $("#orgA").append(selectData.replace("{name}", org.name).replace("{id}", org.idOrg));
                    $("#orgB").append(selectData.replace("{name}", org.name).replace("{id}", org.idOrg));
                });
            }
        });
    }

    /**
     * 整合时需要传值的变量
     * MatchId
     */
    function createSch() {
        var postData = new FormData(document.getElementById("createSchForm"));
        postData.append("matchId", matchId); //TODO 改为Seession，后台确定组织ID。否则不安全
        console.log(postData);
        postData.set("time", Date.parse(postData.get("time")));
        datas = postData.entries();
        console.log(datas.next());
        $.ajax({
            type: "post",//方法类型
            url: "/schedule/create",//url
            data: postData,
            contentType: false,
            processData: false,
            success: function (result) {
                console.log(result);//打印服务端返回的数据(调试用)
                alert("恭喜 恭喜");   //TODO 做成功失败提醒
            },
            error: function () {
                alert("Fail");
            }
        });
    }

    function initTeam(orgId, isA) {
        formId = isA == "orgA" ? "#teamA" : "#teamB";
        $(formId).empty();
        $.ajax({
            url: "/schedule/showTeams/" + matchId + "/" + orgId,
            type: "GET",
            dataType: "json",
            success: function (teamData) {
                var len = teamData.data.teams.length;
                var teams = teamData.data.teams;
                if (len <= 0) {
                    $(formId).append('<option>未获取到组织信息</option>');
                }
                $.each(teams, function (index, team) {
                    console.log(team);
                    $(formId).append(selectData.replace("{name}", team.name).replace("{id}", team.idTeam));
                });
            }
        });
    }

    $(document).ready(function () {
        matchId = document.getElementById("mid").value;
        initOrg();
        $("#orgA,#orgB").change(function () {
            orgId = $(this).children('option:selected').val();
            console.log($(this).attr("id"));
            initTeam(orgId, $(this).attr("id"));
        });

    });
</script>
</html>

