package cn.nsu.edu.web.four.controllers;

import cn.nsu.edu.web.four.annotation.FileRename;
import cn.nsu.edu.web.four.annotation.Security;
import cn.nsu.edu.web.four.dto.ctv.MessageDto;
import cn.nsu.edu.web.four.enums.Result;
import cn.nsu.edu.web.four.enums.Role;
import cn.nsu.edu.web.four.services.DemoService;
import cn.nsu.edu.web.four.services.common.UploadService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import java.io.File;

/**
 * 需要加上模块url前缀
 */
@Controller
@RequestMapping("/demo/")
public class DemoController {

    @Autowired
    private HttpServletRequest request;
    //输出使用日志输出，禁止使用System.out
    private Logger log = LoggerFactory.getLogger(getClass());


    //获取下一层实例
    @Autowired
    private DemoService service;

    @Autowired
    private UploadService uploadService;

    /*
     * 跳转到页面
     */
    @RequestMapping(value = "index", method = RequestMethod.GET)
    public String index() {
        return "";
    }

    /*
     * 返回json数据的用法
     */
    @RequestMapping("testJson")
    @ResponseBody
    public MessageDto testJson() {

        MessageDto dto = new MessageDto(Result.SUCCESS);
        dto.setMessage("该方法仅在失败时使用，以提供前台错误信息");
        //使用该方法传递额外的数据
        dto.put("other", "");
//        return new Me
        return dto;
    }

    /*
     * 权限注解使用方法
     * 这样表示 该请求创建token
     *
     */
    @RequestMapping("/testAuthority")
    @Security
    public String testAuthority() {
        return "";
    }

    /*
     * 该请求验证token，同时该请求只能由学校，机构权限访问
     */
    @RequestMapping("/testToken")
    @Security(checkToken = true, roles = {Role.SCHOOL, Role.ORGANIZATION})
    public String checkToken() {
        return "";
    }

    /**
     * 文件上传
     *
     * @param file
     * @return
     */
    @RequestMapping("/fileUpload")
    public String fileUpload(MultipartFile file) {
        //此为采用默认的文件重命名方式
        String result = uploadService.upload(file, request);

        //这样为自定义文件重命名方式
//        File result = uploadService.upload(file, request, new FileRename() {
//            @Override
//            public String rename(MultipartFile file, HttpServletRequest request) {
//                return "test.jpg";
//            }
//        });notepad

        if (result == null) {//文件上传失败，多半是验证不通过
            //获取错误信息
            String message = uploadService.getMessage();
        }

        return "";
    }
}
