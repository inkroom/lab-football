<!DOCTYPE html>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jstl/fmt" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>

<head>
    <meta charset="utf-8">
    <title>教练列表</title>

    <link rel="stylesheet" type="text/css"
          href="${pageContext.request.contextPath}/resources/lib/bootstrap/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath}/resources/css/match/style.1.0.css"/>
    <link href="${pageContext.request.contextPath}/resources/css/coach/coach_list.css" rel="stylesheet"/>
    <link href="${pageContext.request.contextPath}/resources/lib/layer/default/layer.css"/>


</head>

<body>
<input type="hidden" id="token" value="${token}">
<nav class="nav-bg navbar">
    <div class="container">
        <div class="logo-w col-lg-4 col-md-5 col-sm-11 col-xs-12">
            <img src="${pageContext.request.contextPath}/resources/img/coach/logo足球项目组.png"/>
            <span>四川省青少年校园足球信息网</span>
        </div>
        <div class="nav-b hidden-lg hidden-md col-sm-1 hidden-xs">
            <button type="button" class="btn">菜单</button>
        </div>
        <div class="nav-w col-lg-8 col-md-7 hidden-sm hidden-xs">
            <ul>
                <li>
                    <a href="#">赛事赛程</a>
                </li>
                <li>
                    <a href="#">教练管理</a>
                </li>
                <li>
                    <a href="#">球员管理</a>
                </li>
                <li>
                    <a href="#">球队管理</a>
                </li>
                <li>
                    <a href="#">个人中心</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<br/>

<table class="table table-bordered text-center table-striped class">
    <tr>
        <th>
            <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#myModal">添加教练</button>
            <div id="xuanxiang">
                <div class="btn-group">
                    <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" id="coachzt">
                        <span class="caret"></span></button>
                    <ul class="dropdown-menu" role="menu">
                        <li>
                            <a href="${pageContext.request.contextPath}/coach/getAllCoach/0">在职教练</a>
                        </li>
                        <li>
                            <a href="${pageContext.request.contextPath}/coach/getAllCoach/1">离职教练</a>
                        </li>
                    </ul>
                </div>
            </div>
        </th>
    </tr>
</table>

<br/>
<div id="all" class="clearfix" style="margin:0 100px;">

    <div class="row">
        <c:forEach var="allCoach" items="${allCoach}">
            <div class="col-sm-6 col-md-2">
                <div class="thumbnail">
                    <fmt:bundle basename="properties.upload">

                        <img src="${pageContext.request.contextPath}/<fmt:message key="upload.image.url.prefix"/>/${allCoach.photo}"
                             style=" width: 120px;height: 140px;">

                    </fmt:bundle>
                    <a href="${pageContext.request.contextPath}/coach/getCoach/${allCoach.idCoach}">
                        <div class="caption">
                            <h3>${allCoach.name}</h3>
                        </div>
                    </a>
                </div>
            </div>
        </c:forEach>

    </div>

    <%--<nav aria-label="Page navigation" class="pull-right">--%>
    <%--<ul class="pagination">--%>
    <%--<li>--%>
    <%--<a href="#" aria-label="Previous">--%>
    <%--<span aria-hidden="true">&laquo;</span>--%>
    <%--</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#">1</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#">2</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#">3</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#">4</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#">5</a>--%>
    <%--</li>--%>
    <%--<li>--%>
    <%--<a href="#" aria-label="Next">--%>
    <%--<span aria-hidden="true">&raquo;</span>--%>
    <%--</a>--%>
    <%--</li>--%>
    <%--</ul>--%>
    <%--</nav>--%>
</div>

<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    添加新教练
                </h4>
            </div>
            <div class="modal-body">
                <form id="form" enctype="multipart/form-data">
                    <div class="modalimg">
                        <div>
                            <div class="modalimg">
                                <img src="${pageContext.request.contextPath}/resources/img/coach/upimg1.png"
                                     style="width: 120px;height: 140px;" id="preview">
                                <input class="form-control" type="file" name="files" id="image"
                                       style="opacity:0; filter:alpha(opacity=0); margin-left: 0px;height: 140px; width: 120px; position: absolute; z-index: 9;"
                                       onchange="imgPreview(this)">
                            </div>
                            <div style="text-align: center;color: #288b22">请传入证件照（大小200K以下,宽:高=120:140）</div>
                        </div>

                    </div>
                    <div class="form-group">
                        <label for="inputName" class="col-sm-2 control-label">姓名</label>
                        <div class="col-sm-10">
                            <input class="form-control" id="inputName" name="name" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputIdcard" class="col-sm-2 control-label">身份证号</label>
                        <div class="col-sm-10">
                            <input class="form-control" id="inputIdcard" name="idcard" value="">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="inputPhone" class="col-sm-2 control-label">电话号码</label>
                        <div class="col-sm-10">
                            <input class="form-control" id="inputPhone" name="phone" value="">
                        </div>
                    </div>

                    <div class="form-group">

                        <label class="col-sm-2 control-label">性别</label>
                        <div class="col-sm-10">
                            <select class="form-control" id="pid" onchange="Gender()">
                                <option grade="1">男</option>
                                <option grade="0">女</option>
                            </select>
                        </div>
                    </div>
                    <div id="gr">
                        <input type="hidden" id="inputSex" placeholder="" name="sex" value="1">
                    </div>
                    <input type="hidden" id="inputOrgid" placeholder="" name="orgId" value="${org_id}">
                </form>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal" >关闭</button>

                <button type="button" class="btn btn-primary" onclick="tt()">
                    确定
                </button>
            </div>


        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal -->
</div>

<!-- 全局js -->
<script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.js"></script>
<script src="${pageContext.request.contextPath}/resources/lib/jquery/jquery-1.11.3.js"></script>
<script src="${pageContext.request.contextPath}/resources/lib/bootstrap/bootstrap.min.js"></script>
<script src="${pageContext.request.contextPath}/resources/lib/layer/layer.js"></script>
<script src="${pageContext.request.contextPath}/resources/lib/ajaxFileUpload.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/index.js"></script>


<script>
    function tt() {
        checkCard();
        isCardNo();
        var id = document.getElementById("form").getElementsByTagName("input");
        for(var x = 0; x < id.length; x++) {

        }
    };

    var vcity = {
        11: "北京",
        12: "天津",
        13: "河北",
        14: "山西",
        15: "内蒙古",
        21: "辽宁",
        22: "吉林",
        23: "黑龙江",
        31: "上海",
        32: "江苏",
        33: "浙江",
        34: "安徽",
        35: "福建",
        36: "江西",
        37: "山东",
        41: "河南",
        42: "湖北",
        43: "湖南",
        44: "广东",
        45: "广西",
        46: "海南",
        50: "重庆",
        51: "四川",
        52: "贵州",
        53: "云南",
        54: "西藏",
        61: "陕西",
        62: "甘肃",
        63: "青海",
        64: "宁夏",
        65: "新疆",
        71: "台湾",
        81: "香港",
        82: "澳门",
        91: "国外"
    };

    checkCard = function() {
        var id = document.getElementById("form").getElementsByTagName("input");
        var truename = id[1].value;
        var reg = /^[\u4e00-\u9fa5]{2,4}$/i;
        var img = document.getElementById("image");
        var myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
        if(img.value == "") {
            layer.alert("请选择图片");
        } else if(!reg.test(truename)) {
            layer.alert("请输入真实姓名，只能是2-4个汉字！");
            id[1].focus();
        } else {
            var card = id[2].value;
            //是否为空
            if(card === '') {
                layer.alert('请输入身份证号，身份证号不能为空');
                alert("1");
                id[2].focus();
                return false;
            }
            //校验长度，类型
            if(isCardNo(card) === false) {
                layer.alert('您输入的身份证号码不正确，请重新输入');
                alert("221");
                id[2].focus();
                return false;
            }
            //检查省份
            if(checkProvince(card) === false) {
                layer.alert('您输入的身份证号码不正确,请重新输入');
                alert("3");
                id[2].focus();
                return false;
            }
            //校验生日
            if(checkBirthday(card) === false) {
                layer.alert('您输入的身份证号码生日不正确,请重新输入');
                alert("4");
                id[2].focus();
                return false;
            }
            //检验位的检测
            if(checkParity(card) === false) {
                layer.alert('您的身份证校验位不正确,请重新输入');
                id[2].focus();
                return false;
            }
            if (!myreg.test(id[3].value)) {
                layer.alert('手机号码不正确');
                id[2].focus();
                return false;
            }

            // layer.alert('身份证验证通过，可以注册');
            addCoach();
            return true;
        }
    };

    //检查号码是否符合规范，包括长度，类型
    isCardNo = function(card) {
        //身份证号码为15位或者18位，15位时全为数字，18位前17位为数字，最后一位是校验位，可能为数字或字符X
        var reg = /(^\d{15}$)|(^\d{17}(\d|X)$)/;
        if(reg.test(card) === false) {
            return false;
        }

        return true;
    };

    //取身份证前两位,校验省份
    checkProvince = function(card) {
        var province = card.substr(0, 2);
        if(vcity[province] == undefined) {
            return false;
        }
        return true;
    };

    //检查生日是否正确
    checkBirthday = function(card) {
        var len = card.length;
        //身份证15位时，次序为省（3位）市（3位）年（2位）月（2位）日（2位）校验位（3位），皆为数字
        if(len == '15') {
            var re_fifteen = /^(\d{6})(\d{2})(\d{2})(\d{2})(\d{3})$/;
            var arr_data = card.match(re_fifteen);
            var year = arr_data[2];
            var month = arr_data[3];
            var day = arr_data[4];
            var birthday = new Date('19' + year + '/' + month + '/' + day);
            return verifyBirthday('19' + year, month, day, birthday);
        }
        //身份证18位时，次序为省（3位）市（3位）年（4位）月（2位）日（2位）校验位（4位），校验位末尾可能为X
        if(len == '18') {
            var re_eighteen = /^(\d{6})(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)$/;
            var arr_data = card.match(re_eighteen);
            var year = arr_data[2];
            var month = arr_data[3];
            var day = arr_data[4];
            var birthday = new Date(year + '/' + month + '/' + day);
            return verifyBirthday(year, month, day, birthday);
        }
        return false;
    };

    //校验日期
    verifyBirthday = function(year, month, day, birthday) {
        var now = new Date();
        var now_year = now.getFullYear();
        //年月日是否合理
        if(birthday.getFullYear() == year && (birthday.getMonth() + 1) == month && birthday.getDate() == day) {
            //判断年份的范围（3岁到100岁之间)
            var time = now_year - year;
            if(time >= 3 && time <= 100) {
                return true;
            }
            return false;
        }
        return false;
    };

    //校验位的检测
    checkParity = function(card) {
        //15位转18位
        card = changeFivteenToEighteen(card);
        var len = card.length;
        if(len == '18') {
            var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
            var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
            var cardTemp = 0,
                i, valnum;
            for(i = 0; i < 17; i++) {
                cardTemp += card.substr(i, 1) * arrInt[i];
            }
            valnum = arrCh[cardTemp % 11];
            if(valnum == card.substr(17, 1)) {
                return true;
            }
            return false;
        }
        return false;
    };

    //15位转18位身份证号
    changeFivteenToEighteen = function(card) {
        if(card.length == '15') {
            var arrInt = new Array(7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2);
            var arrCh = new Array('1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2');
            var cardTemp = 0,
                i;
            card = card.substr(0, 6) + '19' + card.substr(6, card.length - 6);
            for(i = 0; i < 17; i++) {
                cardTemp += card.substr(i, 1) * arrInt[i];
            }
            card += arrCh[cardTemp % 11];
            return card;
        }
        return card;
    };

    function addCoach() {
        var info = document.getElementById("form").getElementsByTagName("input");
        // $('#image').remove();
        //$('#buttons').append(' <input type="file" style="display: none" name="file" id="image" accept="image/*" >');
        // $('#image').on('change', function () {
        //    $('#img').attr('disabled', true).addClass('disabled');
        //})
        $.ajaxFileUpload({
            url: "${pageContext.request.contextPath}/coach/addCoach",
            type:"POST",
            secureuri: false,
            fileElementId: 'image',
            dataType: 'json',
            data:{
                name:info[1].value,
                idcard:info[2].value,
                phone:info[3].value,
                sex:info[4].value,
                orgId:info[5].value,
                token: $('#token').val()
            },
            success: function (data, status) {

                $('#img').removeAttr('disabled').removeClass('disabled');
                // $(this).attr('disabled', true).addClass('disabled');
                if (data.status == 0) {
                    layer.msg('创建成功');
                    setTimeout("rel()", "1000");
                } else if (data.status == 1) {
                    layer.msg('数据有误创建失败');
                    setTimeout("rel()", "1000");
                }
            },
            error: function (data, status, e)//服务器响应失败处理函数
            {
                layer.msg('服务器错误');
            },

        })

    }

    function rel() {
        window.location.reload();
    }

    <%--function createFileChooser() {--%>
    <%--var info = document.getElementById("form").getElementsByTagName("input");--%>
    <%--$.ajaxFileUpload({--%>
    <%--url: '${pageContext.request.contextPath}/coach/addCoach2',--%>
    <%--secureuri: false,--%>
    <%--fileElementId: 'image',--%>
    <%--dataType: 'json',--%>
    <%--data:{--%>
    <%--name:info[0].value,--%>
    <%--idcard:info[1].value,--%>
    <%--phone:info[2].value,--%>
    <%--sex:info[3].value,--%>
    <%--orgId:info[4].value,--%>
    <%--},--%>
    <%--success: function (data, status) {--%>
    <%--if (data.status === 0) {--%>
    <%--layer.msg('图片上传成功')--%>
    <%--} else if (data.status === 1) {--%>
    <%--layer.msg('图片上传失败');--%>
    <%--}--%>
    <%--},--%>
    <%--error: function ()//服务器响应失败处理函数--%>
    <%--{--%>

    <%--layer.msg('服务器错误');--%>
    <%--}--%>
    <%--})--%>

</script>

<script type="text/javascript">
    function Gender() {
        var objS = document.getElementById("pid");
        var grade = objS.options[objS.selectedIndex].getAttribute('grade');
        var gr = document.getElementById("gr").getElementsByTagName("input");
        gr[0].value = grade;
    }

</script>

<script type="text/javascript">
    function imgPreview(fileDom) {
        //判断是否支持FileReader
        if (window.FileReader) {
            var reader = new FileReader();
        } else {
            layer.alert("您的设备不支持图片预览功能，如需该功能请升级您的设备！");
        }

        //获取文件
        var file = fileDom.files[0];
        var imageType = /^image\//;
        var size = file.size / 1024;
        //是否是图片
        if (!imageType.test(file.type)) {
            layer.alert("请选择图片！");
            return;
        } else if (size > 200) {
            layer.alert("图片大小不能大于200k");
        } else {
            //读取完成
            reader.onload = function (e) {
                //获取图片dom
                var img = document.getElementById("preview");
                //图片路径设置为读取的图片
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

</script>
<script>
    var test = window.location.href;
    var coachnum = test.substr(-1);
    var coachul = document.getElementById("coachzt");
    if (coachnum == 0) {
        coachul.innerHTML = "在职教练 <span class=\"caret\"></span>"
    } else if (coachnum == 1) {
        coachul.innerHTML = "离职教练 <span class=\"caret\"></span>"
    } else {
        coachul.innerHTML = "查看教练就职状态 <span class=\"caret\"></span>"
    }

</script>


</body>


</html>