package cn.nsu.edu.web.four.services.live;

import cn.nsu.edu.web.four.beans.live.LiveMessageBean;
import cn.nsu.edu.web.four.daos.jdbc.live.LiveDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class LiveService {
    @Autowired
    private LiveDao liveDao;

    public List<LiveMessageBean> getAllMessage(long schId) {
        try {
            List<LiveMessageBean> result = liveDao.getAllMessage(schId);
            Pattern pattern = Pattern.compile("<img src=\"(.+)\"");
            result.forEach(bean -> {
                //提取图片路径
                Matcher matcher = pattern.matcher(bean.getContent());
                if (matcher.find()) {
                    bean.setImgPath(matcher.group(1));
                }
                String orgPhone = bean.getPhone();
                //隐藏手机号码
                bean.setPhone(orgPhone.substring(0, 3) + "****" + orgPhone.substring(7, 11));
            });
            return result;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    public boolean addMessage(long schId, LiveMessageBean bean) {
        bean.setSchId(schId);
        try {
            return liveDao.addMessage(bean) == 1;
        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }


}
