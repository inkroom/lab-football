var match;

context = {
    num: 10,
    btn_num: 0,
    btn_max: 5,
    totalSize: 0,
    cur_page: 0,
    cur_index: 1,
    page_num: 0,
    isError: false,
    isCreateBtn: false,
    //isCreatePage: true
};
trData = "<tr><td>{time}</td><td>{place}</td><td><a href='javascript:showdiv();' id='strHref' class='hpn-1'>{teamA}</a></td><td><b>{scoreA}&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;{scoreB}</b></td><td><a href='#'>{teamB}</a></td><td>{status}</td><td><button class='btn btn-success btn-sm'><a href='../../modify.html'>修改</a></button><button class='btn btn-danger btn-sm'>删除</button></td></tr>";
liData = "<li dom_type='page_btn' onclick='pageClick(this)' index='{index}'><a href='#'>{pageNum}</a></li>";

$(document).ready(function () {
    match = document.getElementById("mid").value;
    matchDetails();
    $("#home-tab").click(function () {
        matchDetails();
    });
    $("#profile-tab").click(function () {
        schedule();
    });
    $("#dropdown1-tab").click(function () {
        examine();
    });
});

function formatDate(date) {
    dates = date.split("/");
    if (dates.length == 3) {
        if (dates[1].length == 1) {
            dates[1] = "0" + dates[1];
        }
        if (dates[2].length == 1) {
            dates[2] = "0" + dates[2];
        }
        date = dates.join("-");
        return date;
    } else {
        return null;
    }
}

function parseTime(timestamp) {

    var date = new Date(parseInt(timestamp)).toLocaleDateString();
    date = formatDate(date);
    return date;
}

function getMatchLevel(level) {
    switch (level) {
        case 0:
            return "校级";
        case 1:
            return "县级";
        case 2:
            return "市级";
        case 3:
            return "省级";
        case 4:
            return "国级";
        default:
            return "Error Level Code" + level;
    }
}


function getMatchStatus(status) {
    switch (status) {
        case 0:
            return "报名阶段";
        case 1:
            return "进行中";
        case 2:
            return "已结束";
        case 3:
            return "删除状态"
    }
}

var matchDetails;

function matchDetails() {
    $.ajax({
            url: "/match/MatchInfo/" + match,
            success: function (matchInfo) {
                matchDetails = matchInfo;
                $("#matchName").text(matchDetails.data.matchInfo.name);
                $("#titleName").append(matchDetails.data.matchInfo.name);
                $("#matchLevel").text(getMatchLevel(matchDetails.data.matchInfo.level));
                $("#matchStatus").text(getMatchStatus(matchDetails.data.matchInfo.status));
                $("#matchNumPlayer").text(matchDetails.data.matchInfo.numPlayer + "人");
                $("#matchStartTime").text(parseTime(matchDetails.data.matchInfo.startDate));
                $("#matchDeadLine").text(parseTime(matchDetails.data.matchInfo.applyDeadline));
            }
        }
    );
}


function pageClick(cur_this) {
    $(cur_this).attr("class", "active");
    var selector = "[index=" + (context.cur_index) + "]";
    $(selector).removeAttr("class");
    showSchedule(match, String($(cur_this).text()));
    context.cur_index = parseInt($(cur_this).attr("index"));
}


function showSchedule(idMatch, page) {
    postData = "idMatch=" + idMatch;
    $.ajax({
        async: false,
        url: "/schedule/showSchedule/" + page,
        type: "POST",
        data: postData,
        dataType: "json",
        error: function () {
            context.isError = true;
            $("#schedule-data tbody").empty();
            errorMessge = '<tr><td></td><td></td><td>获取信息失败!</td><td></td><td></td><td></td></tr>';
            $("#schedule-data tbody").append(errorMessge);
            $("#schedule-data").css("visibility", "visible");
        },
        success: function (data, status) {
            context.isError = false;
            context.totalSize = data.data.size;
            context.cur_page = page;
            var realSize = data.data.schedule.length;
            var num = realSize <= context.num ? realSize : context.num;
            context.isCreateBtn = (data.data.size > context.num);
            $("#schedule-data tbody").empty();
            for (var i = 0; i < num; i++) {
                var time = new Date(Number(data.data.schedule[i].time));
                var beginTime = String(time.getFullYear() + "/" + time.getMonth() + "/" + time.getDate());
                var state = null;
                switch (data.data.schedule[i].status)
                {
                    case 0:
                        state = "正在准备";
                        break;
                    case 1:
                        state = "正在比赛";
                        break;
                    case 2:
                        state = "比赛结束";
                        break;
                    case 3:
                        state = "已删除";
                        break;
                }
                var tr = trData.replace("{time}", beginTime).replace("{place}", data.data.schedule[i].place)
                    .replace("{teamA}", data.data.schedule[i].teamNameA).replace("{scoreA}", String(data.data.schedule[i].goalA))
                    .replace("{scoreB}", String(data.data.schedule[i].goalB)).replace("{teamB}", data.data.schedule[i].teamNameB)
                    .replace("{status}", state);
                $("#schedule-data tbody").append(tr);
            }
            $("#schedule-data").css("visibility", "visible");
        }
    });
}


function schedule() {


    $("#schedule-list").click(function ()
    {
        //if (context.isCreatePage)
        {
            showSchedule(match, 1);
            if (context.isError) {
                return;
            }



            if (context.isCreateBtn) {
                context.page_num = parseInt(context.totalSize / context.num);
                if (context.page_num < context.totalSize / context.num) {
                    context.page_num++;
                }
                var realBtn_num = (context.page_num < context.btn_max) ? context.page_num : context.btn_max;
                for (var i = 1, tmp = ""; i <= realBtn_num; i++) {
                    tmp += liData.replace("{pageNum}", String(i)).replace("{index}", String(i));
                }
                context.btn_num = realBtn_num;
                $("#previous").after(tmp);
                $("#pageBtn").css("display", "block");
                $("[dom_type=page_btn]:eq(0)").attr("class", "active");
            }
            //context.isCreatePage = false;
        }
    });

    $("#next").click(function ()
    {
        $(this).children("a").css("background-color", "white");
        if (context.cur_page >= context.page_num)
        {
            return;
        }
        else if (context.cur_index === context.btn_num)
        {
            $("[dom_type=page_btn]").each(function () {
                var number = parseInt($(this).text()) + context.btn_num;
                if (number > context.page_num) {
                    $(this).css("display", "none");
                }
                else {
                    $(this).children("a").text(String(number));
                }
            });
            $("[index=1]").click();
        }
        else {
            var selector = "[index=" + (context.cur_index + 1) + "]";
            $(selector).click();
        }

    });

    $("#previous").click(function ()
    {
        $(this).children("a").css("background-color", "white");
        if (context.cur_page <= 1)
        {
            return;
        }
        if (context.cur_index === 1)
        {
            var number = parseInt($("[index=1]").text()) - context.btn_num;
            $("[dom_type=page_btn]").each(function () {
                $(this).children("a").text(String(number));
                $(this).css("display", "inline");
                number++;
            });
            var selector = "[index=" + context.btn_max + "]";
            $(selector).click();
        }
        else {
            var selector = "[index=" + (context.cur_index - 1) + "]";
            $(selector).click();
        }
    });
};


var nowpage;

function examine() {
    toPage(1);

    $(document).on("click", ".pass", function () {
        input($(this).attr("id"), 1);

    })
    $(document).on("click", ".danger", function () {
        input($(this).attr("id"), 2);
    })
}

function input(oid, status) {
    $.ajax({
        url: "/match/setExamine",
        data: {id: oid, status: status},
        type: "GET",
        success: function (result) {
            if (result.status == 0) {
                toPage(nowpage);
            }
        }
    })

}

function toPage(pn) {
    $.ajax({
        url: "/match/listExamine",
        data: {pn: pn, mid: match},
        dataType: "json",
        type: "GET",
        success: function (result) {
            if (result.status == 0) {
                buildTable(result);
                build_page_nav(result);
            }
            else if (result.status == 1) {
                $("#body").empty();
                $("<tr></tr>").append("无数据").appendTo("#body");

            }
        }
    });
}

function buildTable(result) {
    nowpage = result.data.pageInfo.pageNum;
    $("#body").empty();
    $.each(result.data.pageInfo.list, function (index, item) {
        var orgid = item.orgId;
        var nameTd = $("<td></td>").append(item.orgName);
        var teamTd = $("<td></td>");
        $.each(item.teamName, function (index, item) {
            var li = $("<li></li>").append(item);
            teamTd.append(li).append(" ");
        });
        var passBtn = $("<button></button>").addClass("btn btn-success pass").append("通过");
        passBtn.attr("id", orgid);
        var refuseBtn = $("<button></button>").addClass("btn btn-danger danger").append("拒绝");
        refuseBtn.attr("id", orgid);
        var btn = $("<td></td>").append(passBtn).append(" ").append(refuseBtn);
        $("<tr></tr>")
            .append(nameTd)
            .append(teamTd)
            .append(btn)
            .appendTo("#body");

    })
}

function build_page_nav(result) {
    $("#pageInfo").empty();
    var ul = $("<ul></ul>").addClass("pagination");
    var firstPageLi = $("<li></li>").append($("<a></a>").append("首页"));
    var prePageLi = $("<li></li>").append($("<a></a>").append("&laquo;"));
    if (result.data.pageInfo.hasPreviousPage == false) {
        firstPageLi.addClass("disabled");
        prePageLi.addClass("disabled");
    } else {
        firstPageLi.click(function () {
            toPage(1);
        });
        prePageLi.click(function () {
            toPage(result.data.pageInfo.pageNum - 1);
        });
    }

    var nextPageLi = $("<li></li>").append($("<a></a>").append("&raquo;"));
    var lastPageLi = $("<li></li>").append($("<a></a>").append("末页"));
    if (result.data.pageInfo.hasNextPage == false) {
        nextPageLi.addClass("disabled");
        lastPageLi.addClass("disabled")
    }
    else {
        nextPageLi.click(function () {
            toPage(result.data.pageInfo.pageNum + 1);
        });
        lastPageLi.click(function () {
            toPage(result.data.pageInfo.pages);
        });
    }

    ul.append(firstPageLi).append(prePageLi);
    $.each(result.data.pageInfo.navigatepageNums, function (index, item) {
        var numLi = $("<li></li>").append($("<a></a>").append(item));
        if (result.data.pageInfo.pageNum == item) {
            numLi.addClass("active")
        }
        numLi.click(function () {
            toPage(item)
        });
        ul.append(numLi);
    });
    ul.append(nextPageLi).append(lastPageLi);
    var navEle = $("<nav></nav>").append(ul);
    navEle.appendTo("#pageInfo");
}